version: 2.1

executors:
  default:
    docker:
      - image: cimg/php:7.2.32

workflows:
  build-test:
    jobs:
      - build
      - test:
          requires:
            - build

jobs:
  build:
    executor: default
    steps:
      - setup-environment
      - install-magento
      - checkout
      - move-repo
      - build-magento
      - persist-workspace
  test:
    executor: default
    steps:
      - attach-workspace
      - run-tests

commands:
  setup-environment:
    steps:
      - run:
          name: install magento dependencies
          command: apt-get install php-bcmath && apt-get install php-intl && apt-get install php7.0-soap

  install-magento:
    steps:
      - run:
          name: download and install Magento 2
          command: git clone -b 2.3 https://github.com/magento/magento2 ./ && composer install

  move-repo:
    steps:
      - run:
          name: make app/code/TurnTo/SocialCommerce dir and copy repo there
          command: mkdir -p app/code/TurnTo/SocialCommerce && ls ~/*

  build-magento:
    steps:
      - run:
          name: run magento commands
          command: php bin/magento setup:upgrade

  persist-workspace:
    steps:
      - persist_to_workspace:
          root: ~/repo
          paths:
            - .
  
  attach-workspace:
    steps:
      - attach_workspace:
          at: ~/repo
  
  run-tests:
    steps:
      - run:
          name: run php unit tests
          command: ./vendor/bin/phpunit -c dev/tests/unit/phpunit.xml.dist app/code/TurnTo/SocialCommerce/Test/Unit